<!DOCTYPE html>
<html>
<head>
    <title>Order Execution Engine Test Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 100px; }
        input, select { padding: 5px; margin: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a87; }
        .status { margin: 20px 0; padding: 10px; border: 1px solid #ddd; background: #f9f9f9; }
        .order { margin: 10px 0; padding: 10px; border-left: 4px solid #007cba; background: #f0f8ff; }
        .confirmed { border-left-color: #28a745; }
        .failed { border-left-color: #dc3545; }
        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: scroll; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Order Execution Engine Test Client</h1>
        
        <div class="form-group">
            <label>Token In:</label>
            <select id="tokenIn">
                <option value="SOL">SOL</option>
                <option value="USDC">USDC</option>
                <option value="USDT">USDT</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Token Out:</label>
            <select id="tokenOut">
                <option value="USDC">USDC</option>
                <option value="SOL">SOL</option>
                <option value="USDT">USDT</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Amount:</label>
            <input type="number" id="amount" value="1.5" step="0.1" min="0.1">
        </div>
        
        <button onclick="submitOrder()">Submit Order</button>
        <button onclick="submitMultipleOrders()">Submit 5 Orders</button>
        <button onclick="clearOrders()">Clear Orders</button>
        
        <div class="status">
            <h3>WebSocket Status: <span id="wsStatus">Disconnected</span></h3>
            <button onclick="connectWebSocket()">Connect WebSocket</button>
            <button onclick="disconnectWebSocket()">Disconnect</button>
        </div>
        
        <div id="orders">
            <h3>Orders</h3>
        </div>
        
        <div class="log" id="log">
            <h4>Console Log</h4>
        </div>
    </div>

    <script>
        let ws = null;
        let orders = new Map();
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocket already connected');
                return;
            }
            
            ws = new WebSocket('ws://127.0.0.1:3000/ws');
            
            ws.onopen = () => {
                document.getElementById('wsStatus').textContent = 'Connected';
                document.getElementById('wsStatus').style.color = 'green';
                log('WebSocket connected');
            };
            
            ws.onmessage = (event) => {
                const update = JSON.parse(event.data);
                log(`Order ${update.orderId}: ${update.status}`);
                updateOrderDisplay(update);
            };
            
            ws.onclose = () => {
                document.getElementById('wsStatus').textContent = 'Disconnected';
                document.getElementById('wsStatus').style.color = 'red';
                log('WebSocket disconnected');
            };
            
            ws.onerror = (error) => {
                log('WebSocket error: ' + error);
            };
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        async function submitOrder() {
            const tokenIn = document.getElementById('tokenIn').value;
            const tokenOut = document.getElementById('tokenOut').value;
            const amount = parseFloat(document.getElementById('amount').value);
            
            if (tokenIn === tokenOut) {
                alert('Token In and Token Out cannot be the same');
                return;
            }
            
            try {
                const response = await fetch('http://127.0.0.1:3000/api/orders/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tokenIn,
                        tokenOut,
                        amount,
                        orderType: 'market'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log(`Order submitted: ${result.orderId}`);
                    orders.set(result.orderId, {
                        id: result.orderId,
                        tokenIn,
                        tokenOut,
                        amount,
                        status: result.status,
                        timestamp: new Date()
                    });
                    updateOrderDisplay({ orderId: result.orderId, status: result.status });
                } else {
                    log(`Error: ${result.error}`);
                }
            } catch (error) {
                log(`Network error: ${error.message}`);
            }
        }
        
        async function submitMultipleOrders() {
            const tokens = ['SOL', 'USDC', 'USDT'];
            const amounts = [1, 1.5, 2, 2.5, 3];
            
            for (let i = 0; i < 5; i++) {
                const tokenIn = tokens[Math.floor(Math.random() * tokens.length)];
                let tokenOut = tokens[Math.floor(Math.random() * tokens.length)];
                while (tokenOut === tokenIn) {
                    tokenOut = tokens[Math.floor(Math.random() * tokens.length)];
                }
                const amount = amounts[i];
                
                document.getElementById('tokenIn').value = tokenIn;
                document.getElementById('tokenOut').value = tokenOut;
                document.getElementById('amount').value = amount;
                
                await submitOrder();
                await new Promise(resolve => setTimeout(resolve, 100)); // Small delay
            }
        }
        
        function updateOrderDisplay(update) {
            const ordersDiv = document.getElementById('orders');
            let orderDiv = document.getElementById(`order-${update.orderId}`);
            
            if (!orderDiv) {
                orderDiv = document.createElement('div');
                orderDiv.id = `order-${update.orderId}`;
                orderDiv.className = 'order';
                ordersDiv.appendChild(orderDiv);
            }
            
            const order = orders.get(update.orderId) || {};
            
            // Update order data
            if (update.status) order.status = update.status;
            if (update.txHash) order.txHash = update.txHash;
            if (update.executedPrice) order.executedPrice = update.executedPrice;
            if (update.selectedDex) order.selectedDex = update.selectedDex;
            if (update.error) order.error = update.error;
            
            orders.set(update.orderId, order);
            
            // Update display
            orderDiv.className = `order ${order.status}`;
            orderDiv.innerHTML = `
                <strong>Order ${update.orderId.substring(0, 8)}...</strong><br>
                ${order.tokenIn} â†’ ${order.tokenOut} (${order.amount})<br>
                Status: <strong>${order.status}</strong><br>
                ${order.selectedDex ? `DEX: ${order.selectedDex}<br>` : ''}
                ${order.executedPrice ? `Price: ${order.executedPrice.toFixed(4)}<br>` : ''}
                ${order.txHash ? `TX: ${order.txHash.substring(0, 16)}...<br>` : ''}
                ${order.error ? `Error: ${order.error}<br>` : ''}
                <small>${order.timestamp ? order.timestamp.toLocaleTimeString() : ''}</small>
            `;
        }
        
        function clearOrders() {
            orders.clear();
            document.getElementById('orders').innerHTML = '<h3>Orders</h3>';
            document.getElementById('log').innerHTML = '<h4>Console Log</h4>';
        }
        
        // Auto-connect WebSocket on page load
        window.onload = () => {
            connectWebSocket();
            log('Page loaded, connecting to WebSocket...');
        };
        
        // Reconnect WebSocket if connection is lost
        setInterval(() => {
            if (!ws || ws.readyState === WebSocket.CLOSED) {
                connectWebSocket();
            }
        }, 5000);
    </script>
</body>
</html>